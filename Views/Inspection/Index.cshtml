@model AMRVI.ViewModels.InspectionViewModel

@{
    ViewData["Title"] = "AM RVI Inspection";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="inspection-portal-v2 container py-4" style="max-width: 650px;">
    <!-- Simple Header -->
    <div class="d-flex flex-column align-items-center mb-4">
        <h1 class="h-label m-0" style="font-size: 1.5rem; letter-spacing: 2px; text-align: center; color: #fff; font-weight: 800; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);">AM RVI</h1>
        <div id="inspectionDate" class="text-secondary small" style="text-align: center; color: rgba(255, 255, 255, 0.7);">@DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")</div>
    </div>

    <!-- Active Session Banner -->
    <div id="activeSessionBanner" class="alert-glass mb-4" style="display: none; animation: slideDown 0.4s ease-out;">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <i class="ph-pulse-fill" style="color: #22d3ee; animation: pulse 1s infinite;"></i>
                <span style="font-size: 0.8rem; font-weight: 700; color: #f1f5f9;">SESI AKTIF DITEMUKAN</span>
            </div>
            <button onclick="abandonCurrentSession()" class="btn-ghost-cyan" style="font-size: 0.7rem; font-weight: 800;">BUAT BARU / RESET</button>
        </div>
    </div>

    <!-- Selection Section -->
    <div id="selectionSection">
        <div class="glass-card-simple" style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <label class="h-label-simple text-nowrap m-0">Pilih Mesin</label>
                <select id="machineSelect" class="form-select deck-select-v2" style="width: 65%;">
                    <option value="">- Pilih Mesin -</option>
                    @foreach (var machine in Model.Machines)
                    {
                        <option value="@machine.Id">@machine.Name</option>
                    }
                </select>
            </div>
        </div>

        <div class="glass-card-simple" style="margin-bottom: 3rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <label class="h-label-simple text-nowrap m-0">No Mesin</label>
                <select id="machineNumberSelect" class="form-select deck-select-v2" style="width: 65%;" disabled>
                    <option value="">- Pilih No Mesin -</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Inspection Items -->
    <div id="inspectionSection">
        <div style="display: flex; flex-direction: row; align-items: center; margin-bottom: 0.5rem; padding: 0 0.5rem; gap: 10px;">
            <label class="h-label-simple m-0">Checklist</label>
            <div id="progressText" style="font-size: 0.9rem; font-weight: 700; color: rgba(255, 255, 255, 0.8); display: none;">0/0</div>
        </div>
        
        <!-- Image Card -->
        <div class="glass-card-simple text-center" style="margin-bottom: 1.5rem;">
            <label class="h-label-small mb-3 d-block">GAMBAR STANDAR</label>
            <div id="imageContainer" class="viewscreen-v2">
                 <i class="ph-camera-bold" style="font-size: 3rem; opacity: 0.2;"></i>
            </div>
        </div>

        <!-- Details & Judgement Card -->
        <div class="glass-card-simple" style="margin-bottom: 1.5rem;">
            <div class="mb-3">
                <label class="h-label-small d-block">Detail</label>
                <div id="detailText" class="value-text text-secondary">No data</div>
            </div>
            
            <div class="mb-3">
                <label class="h-label-small d-block">Standar</label>
                <div id="standardText" class="value-text text-secondary">No data</div>
            </div>

            <hr style="border-top: 1px solid rgba(255,255,255,0.05);">

            <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; width: 100%;">
                <label class="h-label-simple m-0" style="color: #fff; font-weight: 700;">Judgement</label>
                
                <div style="display: flex; gap: 15px;">
                    <label class="judgement-option">
                        <input type="radio" name="currentJudgement" value="OK" disabled>
                        <span class="j-btn ok-v2">OK</span>
                    </label>
                    <label class="judgement-option">
                        <input type="radio" name="currentJudgement" value="NG" disabled>
                        <span class="j-btn ng-v2">NG</span>
                    </label>
                </div>
            </div>

            <!-- Remarks Container (Premium Glass Redesign) -->
            <div id="remarksContainer" class="remarks-glass-container" style="display: none; margin-top: 1.5rem;">
                <div class="remarks-header">
                    <i class="ph-warning-octagon-fill"></i>
                    <span>KETERANGAN DEFECT / NG</span>
                </div>
                <textarea id="ngRemarks" class="remarks-textarea" placeholder="Deskripsikan detail kerusakan atau alasan NG di sini..."></textarea>
                <div class="remarks-footer">Wajib diisi untuk inspeksi status NG</div>
            </div>
        </div>

        <div class="text-center position-relative mt-4" style="width: 100%; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
            
            <!-- Previous Icon (No Background) -->
            <button id="prevBtn" type="button" class="p-0 border-0" style="position: absolute; left: 0; background: none; outline: none; box-shadow: none; fill: #fff; opacity: 0.5; visibility: hidden; cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 -960 960 960" width="28px" fill="currentColor">
                    <path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/>
                </svg>
            </button>

            <button id="nextBtn" class="neural-btn py-3 w-100" disabled>
                NEXT
            </button>
        </div>
    </div>

    <!-- Completion Overlay -->
    <!-- Completion Overlay - Holographic Success Card -->
    <div id="completionSection" class="glass-card-simple text-center py-5" style="display: none; background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95)); border: 1px solid rgba(16, 185, 129, 0.3); box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center;">
        
        <!-- Animated Success Icon -->
        <div class="success-icon-wrapper mb-4" style="position: relative; display: inline-flex; align-items: center; justify-content: center;">
            <div style="position: absolute; width: 80px; height: 80px; background: rgba(16, 185, 129, 0.2); border-radius: 50%; animation: pulseSuccess 2s infinite;"></div>
            <div style="position: absolute; width: 60px; height: 60px; background: rgba(16, 185, 129, 0.4); border-radius: 50%; animation: pulseSuccess 2s infinite 0.5s;"></div>
            <i class="ph-check-circle-fill" style="font-size: 5rem; color: #10b981; z-index: 2; filter: drop-shadow(0 0 20px rgba(16, 185, 129, 0.6));"></i>
        </div>

        <h2 class="mb-2 text-center" style="font-weight: 800; font-size: 2rem; background: linear-gradient(to right, #fff, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">INSPEKSI SELESAI</h2>
        <p class="text-secondary mb-5 text-center" style="font-size: 1rem; letter-spacing: 0.5px;">Data telah terverifikasi dan tersimpan aman di sistem.</p>
        
        @if (User.IsInRole("Administrator") || User.IsInRole("Admin") || User.IsInRole("Supervisor"))
        {
            <button onclick="window.location.href='@Url.Action("Index", "Home")'" class="neural-btn w-100 py-3" style="font-size: 1rem; letter-spacing: 2px;">
                KEMBALI KE DASHBOARD
            </button>
        }
        else
        {
             <button onclick="window.location.reload()" class="neural-btn w-100 py-3" style="font-size: 1rem; letter-spacing: 2px;">
                MULAI INSPEKSI BARU
            </button>
        }
    </div>

    <style>
        @@keyframes pulseSuccess {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @@keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Premium Remarks Styling --- */
        .remarks-glass-container {
            background: rgba(251, 113, 133, 0.03);
            border: 1px solid rgba(251, 113, 133, 0.1);
            border-radius: 12px;
            padding: 1rem;
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .remarks-glass-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(251, 113, 133, 0.3), transparent);
        }

        .remarks-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.75rem;
            color: #fb7185;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .remarks-header i { font-size: 1rem; }

        .remarks-textarea {
            width: 100%;
            min-height: 80px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            color: #f1f5f9;
            font-size: 0.9rem;
            font-family: 'Sora', sans-serif;
            resize: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .remarks-textarea:focus {
            outline: none;
            border-color: rgba(251, 113, 133, 0.4);
            background: rgba(15, 23, 42, 0.6);
            box-shadow: 0 0 20px rgba(251, 113, 133, 0.1);
        }

        .remarks-textarea::placeholder {
            color: rgba(148, 163, 184, 0.4);
            font-size: 0.85rem;
        }

        .remarks-footer {
            margin-top: 0.5rem;
            font-size: 0.65rem;
            color: #94a3b8;
            opacity: 0.6;
            text-align: right;
            font-style: italic;
        }

        .remarks-textarea.invalid-blink {
            border-color: #fb7185 !important;
            animation: blinkRed 0.5s ease 2;
        }

        @@keyframes blinkRed {
            0%, 100% { box-shadow: 0 0 0 rgba(251, 113, 133, 0); }
            50% { box-shadow: 0 0 15px rgba(251, 113, 133, 0.4); }
        }

        /* Session Persistence UI */
        .alert-glass {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid rgba(34, 211, 238, 0.2);
            border-radius: 12px;
            padding: 0.75rem 1.25rem;
            backdrop-filter: blur(10px);
        }

        .btn-ghost-cyan {
            background: none;
            border: 1px solid rgba(34, 211, 238, 0.4);
            color: #22d3ee;
            padding: 4px 10px;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-ghost-cyan:hover {
            background: rgba(34, 211, 238, 0.1);
            border-color: #22d3ee;
        }
    </style>
</div>

<!-- Floating Action Buttons -->
<div class="fab-container">
    <button class="fab" onclick="window.location.href='@Url.Action("Index", "History")'" title="History" style="background: rgba(129, 140, 248, 0.8); backdrop-filter: blur(20px);">
        <i class="ph-clock-counter-clockwise"></i>
    </button>
    
    @if (User.IsInRole("Administrator") || User.IsInRole("Admin") || User.IsInRole("Supervisor"))
    {
        <button class="fab secondary" onclick="window.location.href='@Url.Action("Index", "Home")'" title="Home" style="background: rgba(6, 182, 212, 0.8); backdrop-filter: blur(20px);">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                <path d="M160-120v-375l-72 55-48-64 120-92v-124h80v63l240-183 440 336-48 63-72-54v375H160Zm80-80h200v-160h80v160h200v-356L480-739 240-556v356Zm-80-560q0-50 35-85t85-35q17 0 28.5-11.5T320-920h80q0 50-35 85t-85 35q-17 0-28.5 11.5T240-760h-80Zm80 560h480-480Z"/>
            </svg>
        </button>
    }
</div>

@section Scripts {
    <script>
        let currentState = {
            sessionId: 0,
            items: [],
            currentIndex: 0,
            judgements: {} // Map of itemId -> { result: 'OK'/'NG', remarks: '' }
        };

        // Time Update
        function updateDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB') + ' ' + now.toLocaleTimeString('en-GB'); 
            document.getElementById('inspectionDate').textContent = dateStr;
        }
        setInterval(updateDate, 1000);
        updateDate();

        // Safe Image Fallback Function
        window.handleImageError = function(el) {
            $(el).hide();
            $('#imageContainer').html('<i class="ph-camera-bold" style="font-size: 3rem; opacity: 0.2;"></i>');
        };

        // Initial State
        function setInitialState() {
             $('#imageContainer').html('<i class="ph-camera-bold" style="font-size: 3rem; opacity: 0.2;"></i>');
             $('#detailText').text('No data').addClass('text-secondary');
             $('#standardText').text('No data');
             $('#progressText').text('0/0').hide();
             $('input[name="currentJudgement"]').prop('disabled', true);
             $('#nextBtn, #prevBtn').prop('disabled', true);
             
             // Ensure correct visibility state
             $('#completionSection').hide();
             $('#selectionSection').show();
             $('#inspectionSection').show();
        }
        setInitialState();

        // --- SESSION PERSISTENCE (AUTO-RESUME) ---
        const activeSessionId = @Model.InspectionSessionId;
        if (activeSessionId > 0) {
            resumeActiveSession(activeSessionId);
        }

        function resumeActiveSession(sessionId) {
            $('#detailText').text('Resuming session...');
            $('#activeSessionBanner').fadeIn();
            $.get('@Url.Action("ResumeInspection", "Inspection")', { sessionId: sessionId }, function(response) {
                if (response.success) {
                    currentState.sessionId = response.sessionId;
                    currentState.items = response.checklistItems;
                    currentState.currentIndex = response.currentIndex;
                    currentState.judgements = response.judgements;
                    
                    // Pre-select machine & number (optional but good for consistency)
                    $('#machineSelect').val(response.machineId);
                    
                    // Force load machine numbers then select
                    $.get('@Url.Action("GetMachineNumbers", "Inspection")', { machineId: response.machineId }, function(data) {
                        let options = '<option value="">- Pilih No Mesin -</option>';
                        data.forEach(item => options += `<option value="${item.id}">${item.number}</option>`);
                        $('#machineNumberSelect').html(options).prop('disabled', false).val(response.machineNumberId);
                    });

                    $('input[name="currentJudgement"]').prop('disabled', false);
                    renderCurrentItem();
                } else {
                    console.log("No valid session to resume.");
                    $('#activeSessionBanner').hide();
                    setInitialState();
                }
            });
        }

        function abandonCurrentSession() {
            if (confirm("Anda yakin ingin membatalkan inspeksi ini dan mulai baru? Data yang belum disimpan akan hilang.")) {
                $.post('@Url.Action("AbandonSession", "Inspection")', { sessionId: currentState.sessionId }, function(response) {
                    if (response.success) {
                        currentState.sessionId = 0;
                        currentState.items = [];
                        currentState.currentIndex = 0;
                        currentState.judgements = {};
                        $('#activeSessionBanner').fadeOut();
                        setInitialState();
                        // Reset dropdowns
                        $('#machineSelect').val('');
                        $('#machineNumberSelect').prop('disabled', true).html('<option value="">- Pilih No Mesin -</option>');
                    } else {
                        alert("Gagal mereset sesi: " + response.message);
                    }
                });
            }
        }

        // Machine Selection Logic
        $('#machineSelect').change(function() {
            const machineId = $(this).val();
            $('#machineNumberSelect').prop('disabled', true).html('<option value="">- Pilih No Mesin -</option>');
            setInitialState();

            if (machineId) {
                $.get('@Url.Action("GetMachineNumbers", "Inspection")', { machineId: machineId }, function(data) {
                    let options = '<option value="">- Pilih No Mesin -</option>';
                    if (data && data.length > 0) {
                        data.forEach(item => options += `<option value="${item.id}">${item.number}</option>`);
                    }
                    $('#machineNumberSelect').html(options).prop('disabled', false);
                });
            }
        });

        // Auto Start when Number is Selected
        $('#machineNumberSelect').change(function() {
            const machineNumberId = $(this).val();
            const machineId = $('#machineSelect').val();

            if (machineNumberId && machineId) {
                $('#detailText').text('Loading data...');
                
                $.post('@Url.Action("StartInspection", "Inspection")', 
                    { machineId: machineId, machineNumberId: machineNumberId },
                    function(response) {
                        if (response.success) {
                            currentState.sessionId = response.sessionId;
                            currentState.items = response.checklistItems;
                            currentState.currentIndex = 0;
                            currentState.judgements = {};
                            $('input[name="currentJudgement"]').prop('disabled', false);
                            renderCurrentItem();
                        } else {
                            alert(response.message);
                            setInitialState();
                        }
                    }
                );
            } else {
                 setInitialState();
            }
        });

        $('#nextBtn').click(function() {
            saveCurrentJudgementAndNext();
        });

        $('#prevBtn').click(function() {
            if (currentState.currentIndex > 0) {
                currentState.currentIndex--;
                renderCurrentItem();
            }
        });

        $('input[name="currentJudgement"]').change(function() {
            const val = $(this).val();
            if (val === 'NG') {
                $('#remarksContainer').fadeIn(300);
                $('#ngRemarks').focus();
            } else {
                $('#remarksContainer').fadeOut(200);
                $('#ngRemarks').val('');
            }
            $('#nextBtn').prop('disabled', false);
        });

        function renderCurrentItem() {
            const item = currentState.items[currentState.currentIndex];
            const total = currentState.items.length;
            
            $('#progressText').text(`${currentState.currentIndex + 1}/${total}`).show();
            
            $('#detailText').text(item.detailName);
            $('#standardText').text(item.standardDescription);
            
            if (item.imagePath) {
                $('#imageContainer').html(`<img src="${item.imagePath}" onerror="handleImageError(this)" onclick="window.open(this.src, '_blank')">`);
            } else {
                $('#imageContainer').html('<i class="ph-camera-bold" style="font-size: 3rem; opacity: 0.2;"></i>');
            }

            $('input[name="currentJudgement"]').prop('checked', false);
            $('#remarksContainer').hide();
            $('#ngRemarks').val('');

            if (currentState.judgements[item.id]) {
                 const stored = currentState.judgements[item.id];
                 $(`input[name="currentJudgement"][value="${stored.result}"]`).prop('checked', true);
                 if (stored.result === 'NG') {
                     $('#remarksContainer').show();
                     $('#ngRemarks').val(stored.remarks);
                 }
                 $('#nextBtn').prop('disabled', false);
            } else {
                 $('#nextBtn').prop('disabled', true);
            }

            $('#prevBtn').prop('disabled', currentState.currentIndex === 0);
            $('#prevBtn').css('visibility', currentState.currentIndex === 0 ? 'hidden' : 'visible');
            
            if (currentState.currentIndex === total - 1) {
                 $('#nextBtn').text('FINISH');
            } else {
                 $('#nextBtn').text('NEXT');
            }
        }

        function saveCurrentJudgementAndNext() {
            const item = currentState.items[currentState.currentIndex];
            const result = $('input[name="currentJudgement"]:checked').val();
            const remarks = $('#ngRemarks').val() || '';
            const btn = $('#nextBtn');
            const isLast = currentState.currentIndex === currentState.items.length - 1;
            
            if (!result) return;
            
            // Validation: Remarks required for NG
            if (result === 'NG' && !remarks.trim()) {
                $('#ngRemarks').addClass('invalid-blink');
                setTimeout(() => $('#ngRemarks').removeClass('invalid-blink'), 1500);
                alert('Silakan tulis keterangan alasan NG terlebih dahulu!');
                return;
            }

            // Disable button and show loading
            const originalText = btn.text();
            btn.prop('disabled', true).html('<i class="ph-circle-notch ph-spin"></i> SAVING...');

            currentState.judgements[item.id] = { result: result, remarks: remarks };

             $.ajax({
                url: '@Url.Action("SubmitJudgement", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    inspectionSessionId: currentState.sessionId,
                    checklistItemId: item.id,
                    judgement: result,
                    remarks: remarks
                }),
                success: function(response) {
                    if (response.success) {
                        if (isLast) {
                            showCompletion();
                        } else {
                            currentState.currentIndex++;
                            renderCurrentItem();
                            btn.prop('disabled', false).text(originalText);
                        }
                    } else {
                        alert("Gagal menyimpan data: " + response.message);
                        btn.prop('disabled', false).text(originalText);
                    }
                },
                error: function() {
                    alert("Koneksi terputus. Silakan coba lagi.");
                    btn.prop('disabled', false).text(originalText);
                }
            });
        }

        function showCompletion() {
            $('#selectionSection, #inspectionSection').hide();
            $('#completionSection').fadeIn();
        }
    </script>
}
