@model AMRVI.ViewModels.InspectionViewModel

@{
    ViewData["Title"] = "AM RVI Inspection";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="inspection-portal-v2 container py-4" style="max-width: 650px;">
    <!-- Simple Header -->
    <div class="d-flex flex-column align-items-center mb-4">
        <h1 class="h-label m-0" style="font-size: 1.5rem; letter-spacing: 2px; text-align: center; color: #fff; font-weight: 800; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);">AM RVI</h1>
        <div id="inspectionDate" class="text-secondary small" style="text-align: center; color: rgba(255, 255, 255, 0.7);">@DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")</div>
    </div>

    <!-- Selection Section -->
    <div id="selectionSection">
        <div class="glass-card-simple" style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <label class="h-label-simple text-nowrap m-0">Pilih Mesin</label>
                <select id="machineSelect" class="form-select deck-select-v2" style="width: 65%;">
                    <option value="">- Pilih Mesin -</option>
                    @foreach (var machine in Model.Machines)
                    {
                        <option value="@machine.Id">@machine.Name</option>
                    }
                </select>
            </div>
        </div>

        <div class="glass-card-simple" style="margin-bottom: 3rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <label class="h-label-simple text-nowrap m-0">No Mesin</label>
                <select id="machineNumberSelect" class="form-select deck-select-v2" style="width: 65%;" disabled>
                    <option value="">- Pilih No Mesin -</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Inspection Items -->
    <div id="inspectionSection">
        <label class="h-label-simple mb-2 d-block px-2">Checklist</label>
        
        <!-- Image Card -->
        <div class="glass-card-simple text-center" style="margin-bottom: 1.5rem;">
            <label class="h-label-small mb-3 d-block">GAMBAR STANDAR</label>
            <div id="imageContainer" class="viewscreen-v2">
                 <i class="ph-camera-bold" style="font-size: 3rem; opacity: 0.2;"></i>
            </div>
        </div>

        <!-- Details & Judgement Card -->
        <div class="glass-card-simple" style="margin-bottom: 1.5rem;">
            <div class="mb-3">
                <label class="h-label-small d-block">Detail</label>
                <div id="detailText" class="value-text">-</div>
            </div>
            
            <div class="mb-3">
                <label class="h-label-small d-block">Standar</label>
                <div id="standardText" class="value-text text-secondary">No data</div>
            </div>

            <hr style="border-top: 1px solid rgba(255,255,255,0.05);">

            <div class="d-flex justify-content-between align-items-center">
                <label class="h-label-simple" style="color: #fff; font-weight: 700;">Judgement</label>
                <div class="d-flex gap-4">
                    <label class="judgement-radio">
                        <input type="radio" name="currentJudgement" value="OK" disabled>
                        <span class="radio-mark"></span>
                        <span class="radio-label">OK</span>
                    </label>
                    <label class="judgement-radio">
                        <input type="radio" name="currentJudgement" value="NG" disabled>
                        <span class="radio-mark"></span>
                        <span class="radio-label">NG</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="text-center">
            <div class="mb-3" id="progressText" style="font-size: 0.9rem; font-weight: 700; color: rgba(255, 255, 255, 0.8);">0/0</div>
            <button id="nextBtn" class="neural-btn w-100 py-3" disabled>
                NEXT
            </button>
            <button id="prevBtn" class="btn btn-link text-secondary mt-2 small" style="visibility: hidden;">
                Previous Task
            </button>
        </div>
    </div>

    <!-- Completion Overlay -->
    <div id="completionSection" class="glass-card-simple text-center py-5" style="display: none;">
        <i class="ph-check-circle-bold mb-3" style="font-size: 4rem; color: var(--success);"></i>
        <h2 class="mb-2">Selesai!</h2>
        <p class="text-secondary mb-4">Semua data inspeksi telah berhasil disimpan.</p>
        <button onclick="window.location.href='@Url.Action("Index", "Home")'" class="neural-btn px-5">
            KEMBALI KE DASHBOARD
        </button>
    </div>
</div>

<!-- Floating Action Buttons -->
<div class="fab-container">
    <button class="fab" onclick="window.location.href='@Url.Action("Index", "History")'" title="History" style="background: rgba(129, 140, 248, 0.8); backdrop-filter: blur(20px);">
        <i class="ph-clock-counter-clockwise"></i>
    </button>
    <button class="fab secondary" onclick="window.location.href='@Url.Action("Index", "Home")'" title="Home" style="background: rgba(251, 191, 36, 0.8); backdrop-filter: blur(20px);">
        <i class="ph-list-bold"></i>
    </button>
</div>

@section Scripts {
    <script>
        let currentState = {
            sessionId: 0,
            items: [],
            currentIndex: 0,
            judgements: {} // Map of itemId -> { result: 'OK'/'NG', remarks: '' }
        };

        // Time Update
        function updateDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB') + ' ' + now.toLocaleTimeString('en-GB'); 
            document.getElementById('inspectionDate').textContent = dateStr;
        }
        setInterval(updateDate, 1000);
        updateDate();

        // Initial State
        function setInitialState() {
             $('#imageContainer').html('<i class="ph-camera-bold" style="font-size: 3rem; opacity: 0.2;"></i>');
             $('#detailText').text('-');
             $('#standardText').text('No data');
             $('#progressText').text('0 / 0');
             $('input[name="currentJudgement"]').prop('disabled', true);
             $('#nextBtn, #prevBtn').prop('disabled', true);
        }
        setInitialState();

        // Machine Selection Logic
        $('#machineSelect').change(function() {
            const machineId = $(this).val();
            $('#machineNumberSelect').prop('disabled', true).html('<option value="">- Pilih No Mesin -</option>');
            setInitialState();

            if (machineId) {
                $.get('@Url.Action("GetMachineNumbers", "Inspection")', { machineId: machineId }, function(data) {
                    let options = '<option value="">- Pilih No Mesin -</option>';
                    if (data && data.length > 0) {
                        data.forEach(item => options += `<option value="${item.id}">${item.number}</option>`);
                    }
                    $('#machineNumberSelect').html(options).prop('disabled', false);
                });
            }
        });

        // Auto Start when Number is Selected
        $('#machineNumberSelect').change(function() {
            const machineNumberId = $(this).val();
            const machineId = $('#machineSelect').val();

            if (machineNumberId && machineId) {
                $('#detailText').text('Loading data...');
                
                $.post('@Url.Action("StartInspection", "Inspection")', 
                    { machineId: machineId, machineNumberId: machineNumberId },
                    function(response) {
                        if (response.success) {
                            currentState.sessionId = response.sessionId;
                            currentState.items = response.checklistItems;
                            currentState.currentIndex = 0;
                            currentState.judgements = {};
                            $('input[name="currentJudgement"]').prop('disabled', false);
                            renderCurrentItem();
                        } else {
                            alert(response.message);
                            setInitialState();
                        }
                    }
                );
            } else {
                 setInitialState();
            }
        });

        $('#nextBtn').click(function() {
            saveCurrentJudgementAndNext();
        });

        $('#prevBtn').click(function() {
            if (currentState.currentIndex > 0) {
                currentState.currentIndex--;
                renderCurrentItem();
            }
        });

        $('input[name="currentJudgement"]').change(function() {
            $('#nextBtn').prop('disabled', false);
        });

        function renderCurrentItem() {
            const item = currentState.items[currentState.currentIndex];
            const total = currentState.items.length;
            
            $('#progressText').text(`${currentState.currentIndex + 1}/${total}`);
            
            $('#detailText').text(item.detailName);
            $('#standardText').text(item.standardDescription);
            
            if (item.imagePath) {
                $('#imageContainer').html(`<img src="${item.imagePath}" onclick="window.open(this.src, '_blank')">`);
            } else {
                $('#imageContainer').html('<i class="ph-camera-bold" style="font-size: 3rem; opacity: 0.2;"></i>');
            }

            $('input[name="currentJudgement"]').prop('checked', false);
            if (currentState.judgements[item.id]) {
                 $(`input[name="currentJudgement"][value="${currentState.judgements[item.id]}"]`).prop('checked', true);
                 $('#nextBtn').prop('disabled', false);
            } else {
                 $('#nextBtn').prop('disabled', true);
            }

            $('#prevBtn').prop('disabled', currentState.currentIndex === 0);
            $('#prevBtn').css('visibility', currentState.currentIndex === 0 ? 'hidden' : 'visible');
            
            if (currentState.currentIndex === total - 1) {
                 $('#nextBtn').text('FINISH');
            } else {
                 $('#nextBtn').text('NEXT');
            }
        }

        function saveCurrentJudgementAndNext() {
            const item = currentState.items[currentState.currentIndex];
            const result = $('input[name="currentJudgement"]:checked').val();
            
            if (!result) return;
            currentState.judgements[item.id] = result;

             $.ajax({
                url: '@Url.Action("SubmitJudgement", "Inspection")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    inspectionSessionId: currentState.sessionId,
                    checklistItemId: item.id,
                    judgement: result,
                    remarks: ''
                }),
                success: function(response) {
                    if (!response.success) console.error('Failed to save background judgement', response.message);
                }
            });

            if (currentState.currentIndex < currentState.items.length - 1) {
                currentState.currentIndex++;
                renderCurrentItem();
            } else {
                showCompletion();
            }
        }

        function showCompletion() {
            $('#selectionSection, #inspectionSection').hide();
            $('#completionSection').fadeIn();
        }
    </script>
}
