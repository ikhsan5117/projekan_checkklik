@model AMRVI.ViewModels.DashboardViewModel

<!-- Hero Section: Atmospheric Command -->
<div class="quantum-hero" style="margin-bottom: 3rem;">
    <div class="hero-glow-1"></div>
    <div class="hero-glow-2"></div>
    <div class="hero-scanline"></div>
    <div class="hero-main">
        <div class="hero-chip">SYSTEM STATUS: NOMINAL</div>
        <h1 class="hero-title">@User.FindFirst("Plant")?.Value <span class="glow-text">Dashboard</span></h1>
        <p class="hero-subtitle">Semua mesin dalam kondisi terpantau. Anda telah melakukan <strong>@Model.InspectionsToday</strong> inspeksi hari ini.</p>
        
    </div>
    
    <div class="hero-sidebar">
        @{
            var auditPercent = Model.TotalMachines > 0 ? (Model.InspectionsToday * 100) / Model.TotalMachines : 0;
        }
            <div class="mini-gauge-card">
                <div class="gauge-ring" style="--percent: @auditPercent;">
                    <svg viewBox="0 0 160 160"><circle cx="80" cy="80" r="70"></circle><circle cx="80" cy="80" r="70"></circle></svg>
                    <div class="gauge-data">
                        <span class="g-num">@Model.TotalMachines</span>
                        <span class="g-unit">UNITS</span>
                    </div>
                </div>
                <p>Audit Progress: @auditPercent%</p>
            </div>
    </div>
</div>

<!-- Main Grid -->
<div class="quantum-grid" style="margin-top: -2rem;">
    <!-- Total Machine Card -->
    <div id="cardMachine" class="bento-card dashboard-stat-card" style="--card-color: #22d3ee; --card-color-rgb: 34, 211, 238;">
        <div class="stat-card-inner">
            <div class="stat-bg-orb"></div>
            <div class="stat-content">
                <div class="stat-meta">
                    <span class="stat-label">TOTAL MC</span>
                </div>
                <div class="stat-main">
                    <h2 class="stat-number">@Model.TotalMachines</h2>
                    <div class="stat-icon-wrapper">
                        <i class="ph-monitor-bold"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total OK Card -->
    <div id="cardOk" class="bento-card dashboard-stat-card" onclick="toggleFilter('ok')" style="--card-color: #34d399; --card-color-rgb: 52, 211, 153;">
        <div class="stat-card-inner">
            <div class="stat-bg-orb"></div>
            <div class="stat-content">
                <div class="stat-meta">
                    <span class="stat-label">TOTAL OK</span>
                    <div class="stat-badge" id="filterBadgeOk" style="display:none;">FILTERED</div>
                </div>
                <div class="stat-main">
                    <h2 class="stat-number" id="totalOkCount">@Model.TotalOkCount</h2>
                    <div class="stat-icon-wrapper">
                        <i class="ph-check-circle-bold"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total NG Card -->
    <div id="cardNg" class="bento-card dashboard-stat-card" onclick="toggleFilter('ng')" style="--card-color: #fb7185; --card-color-rgb: 251, 113, 133;">
        <div class="stat-card-inner">
            <div class="stat-bg-orb"></div>
            <div class="stat-content">
                <div class="stat-meta">
                    <span class="stat-label">TOTAL NG</span>
                    <div class="stat-badge" id="filterBadgeNg" style="display:none;">FILTERED</div>
                </div>
                <div class="stat-main">
                    <h2 class="stat-number" id="totalNgCount">@Model.TotalNgCount</h2>
                    <div class="stat-icon-wrapper">
                        <i class="ph-warning-octagon-bold"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Inspections Card -->
    <div id="cardTotal" class="bento-card dashboard-stat-card active-state" onclick="toggleFilter('all')" style="--card-color: #818cf8; --card-color-rgb: 129, 140, 248;">
        <div class="stat-card-inner">
            <div class="stat-bg-orb"></div>
            <div class="stat-content">
                <div class="stat-meta">
                    <span class="stat-label">TOTAL SESSIONS</span>
                    <div class="stat-badge" id="filterBadgeTotal" style="display:none;">FILTERED</div>
                </div>
                <div class="stat-main">
                    <h2 class="stat-number" id="totalInspectionsCount">@(Model.TotalOkCount + Model.TotalNgCount)</h2>
                    <div class="stat-icon-wrapper">
                        <i class="ph-clipboard-text-bold"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> <!-- Close quantum-grid -->

<!-- NEW: ANALYTICS SPLIT VIEW -->
<div class="analytics-split-view">
    
    <!-- LEFT: UPDATE AM MESIN HARI INI -->
    <div class="analytics-section">
        <h2 class="section-title">UPDATE AM MESIN HARI INI</h2>
        <!-- Changed to side-by-side Layout similar to reference -->
        <div class="summary-cards-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div class="summary-card red" style="display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; height: 80px;">
                <div class="summary-label" style="font-size:0.7rem; margin-bottom:0.25rem;">MC TIDAK UPDATE</div>
                <div class="summary-value" style="font-size:2rem;">@Model.NotUpdatedMachinesCount</div>
            </div>
            <div class="summary-card green" style="display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; height: 80px;">
                <div class="summary-label" style="font-size:0.7rem; margin-bottom:0.25rem;">MC UPDATE</div>
                <div class="summary-value" style="font-size:2rem;">@Model.UpdatedMachinesCount</div>
            </div>
        </div>
        
        <!-- Logic to split list into two columns -->
        @{
            var machines = Model.MachineUpdateList;
            var count = machines.Count;
            var half = (int)Math.Ceiling(count / 2.0);
            var col1 = machines.Take(half).ToList();
            var col2 = machines.Skip(half).ToList();
        }

        <div class="machine-dual-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <!-- Column 1 -->
            <div class="machine-col">
                <table class="machine-status-table compact">
                    <thead>
                        <tr>
                            <th>M/C</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var m in col1)
                        {
                            <tr class="@(m.IsUpdatedToday ? "updated" : "not-updated")">
                                <td>@m.MachineNumber</td>
                                <td>@(m.IsUpdatedToday ? "UPDATE" : "TIDAK")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <!-- Column 2 -->
            <div class="machine-col">
                <table class="machine-status-table compact">
                    <thead>
                        <tr>
                            <th>M/C</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var m in col2)
                        {
                            <tr class="@(m.IsUpdatedToday ? "updated" : "not-updated")">
                                <td>@m.MachineNumber</td>
                                <td>@(m.IsUpdatedToday ? "UPDATE" : "TIDAK")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- RIGHT: TREND TEMUAN ABNORMALITY AM -->
    <div class="analytics-section">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
            <h2 class="section-title" style="margin-bottom:0;">TREND TEMUAN ABNORMALITY AM</h2>
            <input type="month" id="trendMonthPicker" class="cyber-input" style="color-scheme: dark;">
        </div>
        
        <div class="ng-trend-chart">
            <canvas id="ngTrendChart"></canvas>
        </div>
        <div class="ng-detail-table">
            <table id="ngDetailTable">
                <thead>
                    <tr>
                        <th>TANGGAL</th>
                        <th>M/C</th>
                        <th>NG CHECKLIST</th>
                        <th>STANDAR</th>
                        <th>PROBLEM</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var record in Model.NgDetailRecords)
                    {
                        <tr>
                            <td>@record.Date.ToString("dd MMM yyyy")</td>
                            <td>@record.MachineNumber</td>
                            <td>@record.ChecklistItem</td>
                            <td>@record.Standard</td>
                            <td>@record.Problem</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div> <!-- Close analytics-split-view -->

<style>
    /* Cyber Input Styling */
    .cyber-input {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(129, 140, 248, 0.3);
        color: #fff;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-family: 'Outfit', sans-serif;
        font-size: 0.85rem;
        outline: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .cyber-input:focus {
        border-color: #22d3ee;
        box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);
    }

    /* Default Grid (Desktop > 1400px) */
    .quantum-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
    }
    .analytics-card {
        grid-column: span 3;
        grid-row: span 1;
    }
    .feed-card {
        grid-column: span 1; 
        grid-row: span 2; /* Full sidebar height */
        display: flex; flex-direction: column;
    }
    #cardTotal {
        grid-column: span 1; /* Normal 1-col width */
    }
    .stats-card {
        grid-column: span 1;
    }

    /* Pulse Animation */
    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    /* Custom Scrollbar */
    .feed-card div::-webkit-scrollbar { width: 6px; }
    .feed-card div::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 10px; }
    .feed-card div::-webkit-scrollbar-thumb { background: rgba(129, 140, 248, 0.3); border-radius: 10px; }
    .feed-card div::-webkit-scrollbar-thumb:hover { background: rgba(129, 140, 248, 0.5); }

/* --- Dashboard Stat Cards (Cyber-Industrial) --- */
.dashboard-stat-card {
    position: relative;
    padding: 0 !important;
    overflow: hidden;
    background: rgba(15, 23, 42, 0.45);
    border: 1px solid rgba(var(--card-color-rgb), 0.1);
    backdrop-filter: blur(20px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    border-radius: 20px;
    height: 110px; /* Force consistent height */
    box-sizing: border-box;
}

.dashboard-stat-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(var(--card-color-rgb), 0.08), transparent);
    z-index: 0;
}

.stat-card-inner {
    position: relative;
    padding: 1rem 1.25rem;
    height: 100%;
    z-index: 2;
    display: flex;
    flex-direction: column;
}

.stat-bg-orb {
    position: absolute;
    top: -40%;
    right: -20%;
    width: 120px;
    height: 120px;
    background: var(--card-color);
    filter: blur(50px);
    opacity: 0.1;
    z-index: 1;
    transition: opacity 0.5s ease;
}

/* Card States via Classes */
.dashboard-stat-card.active-state {
    border-color: rgba(var(--card-color-rgb), 0.6);
    background: rgba(var(--card-color-rgb), 0.05);
    box-shadow: 0 0 25px rgba(var(--card-color-rgb), 0.1);
}

.dashboard-stat-card.active-state .stat-bg-orb {
    opacity: 0.3;
}

.dashboard-stat-card.filtered-state {
    opacity: 0.2;
    filter: grayscale(0.5) blur(1px);
    pointer-events: auto;
}

.stat-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.15rem;
    height: 24px; /* Fixed height to prevent jumps when badge appears */
}

.stat-label {
    font-size: 0.7rem;
    font-weight: 800;
    letter-spacing: 0.1em;
    color: #94a3b8;
    text-transform: uppercase;
}

.stat-badge {
    font-size: 0.6rem;
    font-weight: 900;
    color: var(--card-color);
    background: rgba(var(--card-color-rgb), 0.1);
    padding: 1px 6px;
    border-radius: 4px;
    border: 1px solid rgba(var(--card-color-rgb), 0.3);
}

.stat-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0;
}

.stat-number {
    font-size: 2.25rem;
    font-weight: 900;
    color: #fff;
    margin: 0;
    line-height: 1;
    font-family: 'Outfit', sans-serif;
    text-shadow: 0 0 20px rgba(var(--card-color-rgb), 0.3);
}

.stat-icon-wrapper {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: rgba(var(--card-color-rgb), 0.1);
    border: 1px solid rgba(var(--card-color-rgb), 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--card-color);
    font-size: 1.25rem;
    box-shadow: inset 0 0 10px rgba(var(--card-color-rgb), 0.1);
}

@@keyframes statusPulse {
    0% { transform: scale(1); opacity: 0.4; }
    50% { transform: scale(3); opacity: 0; }
    100% { transform: scale(1); opacity: 0; }
}

/* --- RESPONSIVE MEDIA QUERIES --- */
@@media (max-width: 1400px) {
    .quantum-grid { grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
    .analytics-card { grid-column: span 3; }
    .feed-card { grid-column: span 3; grid-row: auto; height: 350px; }
}

/* Tablet/Small Laptop (Max 992px) */
@@media (max-width: 992px) {
    .quantum-grid { grid-template-columns: 1fr; }
    .analytics-card, .feed-card, .stats-card, .bento-card { grid-column: span 1; grid-row: auto; }
}
</style>

<style>
    /* Cyber Button Small */
    .cyber-btn-sm {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(129, 140, 248, 0.3);
        color: #fff;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-family: 'Outfit', sans-serif;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex; align-items: center; gap: 0.25rem;
    }
    .cyber-btn-sm:hover:not(:disabled) {
        background: rgba(129, 140, 248, 0.2);
        border-color: #60a5fa;
    }
    .cyber-btn-sm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Premium Table Styling Override */
    .ng-detail-table {
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(129, 140, 248, 0.15);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        /* Horizontal Scroll handled by browser default on overflow */
    }
    
    .ng-detail-table table {
        width: 100%;
        border-collapse: separate; 
        border-spacing: 0;
    }

    .ng-detail-table th {
        /* Brighter Blue Gradient */
        background: linear-gradient(90deg, rgba(59, 130, 246, 0.8) 0%, rgba(37, 99, 235, 0.5) 100%);
        color: #fff; /* Pure white text for contrast */
        font-weight: 700;
        letter-spacing: 0.05em;
        padding: 1rem;
        text-align: left;
        border-bottom: 2px solid #22d3ee; /* Cyan glow border */
        /* Vertical separator */
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        text-transform: uppercase;
        font-size: 0.75rem;
        text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); /* Subtle text glow */
    }

    .ng-detail-table th:last-child {
        border-right: none;
    }

    .ng-detail-table td {
        padding: 0.85rem 1rem;
        color: #cbd5e1;
        border-bottom: 1px solid rgba(148, 163, 184, 0.08); /* Faint horizontal line */
        /* Vertical separator */
        border-right: 1px solid rgba(148, 163, 184, 0.08);
        background: rgba(15, 23, 42, 0.3);
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }

    .ng-detail-table td:last-child {
        border-right: none;
    }

    .ng-detail-table tr:last-child td {
        border-bottom: none;
    }

    /* Hover Effect Row */
    .ng-detail-table tbody tr:hover td {
        background: rgba(96, 165, 250, 0.1);
        color: #fff;
    }

    /* Force Analytics Section to accommodate pagination */
    .analytics-section {
        height: auto !important;
        min-height: 480px; /* Ensure enough height */
        padding-bottom: 2rem !important;
        position: relative;
        overflow: visible !important; /* Allow controls to be seen if strictly overflowing */
    }

    .pagination-controls {
        position: relative;
        z-index: 10;
        margin-top: 1rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(148, 163, 184, 0.1);
    }
</style>

<script>
    // Initialize Charts for this partial
    if (typeof Chart !== 'undefined') {
        const ngTrendCtx = document.getElementById('ngTrendChart');
        if (ngTrendCtx) {
            // Destroy existing if any to prevent canvas reuse error
            if (window.myNgChart) window.myNgChart.destroy();

            // Store table data globally for filtering
            let currentTableData = []; 
            // Pagination state
            let currentPage = 1;
            const rowsPerPage = 10; // Modified to 10 rows per page
            let displayedData = []; // Data currently being displayed/paginated

            // 1. Initial Data from Model (Razor)
            const rawTableData = @Html.Raw(Json.Serialize(Model.NgDetailRecords));
            
            // Map Razor Model data -> matches API structure
            currentTableData = rawTableData.map(r => {
                // Parse date from ISO string (e.g. 2026-02-04T00:00:00)
                const d = new Date(r.date); 
                // Format: "yyyy-MM-dd" for rawDate, locale string for display
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                
                return {
                    date: d.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }),
                    rawDate: `${yyyy}-${mm}-${dd}`, // Standard format for filtering
                    machine: r.machineNumber,
                    checklist: r.checklistItem,
                    standard: r.standard,
                    problem: r.problem
                };
            });

            // Make sure to render initial data with pagination
            // Wait for DOM to be ready implicitly or call it
            setTimeout(() => renderTable(currentTableData, ""), 0);

            // Pagination Controls Event Listeners
            const btnPrev = document.getElementById('btnPrevPage');
            const btnNext = document.getElementById('btnNextPage');

            if (btnPrev && btnNext) {
                btnPrev.addEventListener('click', () => window.changePageInternal(-1));
                btnNext.addEventListener('click', () => window.changePageInternal(1));
            }

            // Set initial month picker value to current month
            const monthPicker = document.getElementById('trendMonthPicker');
            if (monthPicker) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                monthPicker.value = `${yyyy}-${mm}`;
                
                // Event Listener
                monthPicker.addEventListener('change', function() {
                    const val = this.value; // "yyyy-mm"
                    if (!val) return;
                    const [year, month] = val.split('-');
                    updateTrendData(month, year);
                });
            }

            const ngTrendData = @Html.Raw(Json.Serialize(Model.NgTrendDaily));
            const ngLabels = ngTrendData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
            });
            const ngCounts = ngTrendData.map(d => d.ngCount);
            // Store raw dates for click mapping (format yyyy-MM-dd from Model)
            const ngRawDates = ngTrendData.map(d => d.date.split('T')[0]);

            window.myNgChart = new Chart(ngTrendCtx, {
                type: 'bar',
                data: {
                    labels: ngLabels,
                    datasets: [{
                        label: 'JUDGEMENT',
                        data: ngCounts,
                        backgroundColor: '#60a5fa',
                        borderColor: '#60a5fa',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeElements) => {
                        if (activeElements.length > 0) {
                            // Filter by Clicked Date
                            const index = activeElements[0].index;
                            const selectedDate = ngRawDates[index]; // "yyyy-MM-dd"
                            const selectedLabel = ngLabels[index];
                            
                            // Filter table data
                            const filteredData = currentTableData.filter(row => row.rawDate === selectedDate);
                            
                            // Reset to page 1 for filtered view
                            currentPage = 1;
                            renderTable(filteredData, `Menampilkan NG Tanggal: ${selectedLabel}`);
                        } else {
                            // Reset Filter (Click on empty space)
                            currentPage = 1;
                            renderTable(currentTableData, "");
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#94a3b8', font: { size: 12, weight: '600' } }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(129, 140, 248, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8', font: { size: 11 } },
                            grid: { color: 'rgba(129, 140, 248, 0.1)', drawBorder: false }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 10 }, maxRotation: 45, minRotation: 45 },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Function to change page
            window.changePageInternal = function(delta) {
                 currentPage += delta;
                 // Pass explicit null to keep existing message visible without clearing it?
                 // Current logic overwrites message. Let's fix message persistence.
                 const msgEl = document.getElementById("tableFilterMessage");
                 const currentMsg = msgEl ? msgEl.getAttribute("data-msg") : "";
                 renderTable(displayedData, currentMsg);
            };

            function renderTable(data, message) {
                 displayedData = data; // Update global reference
                 
                 const tableBody = document.querySelector("#ngDetailTable tbody");
                 let headerMsg = document.getElementById("tableFilterMessage");
                 
                 // Add message element if missing
                 if (!headerMsg) {
                     const msgDiv = document.createElement("div");
                     msgDiv.id = "tableFilterMessage";
                     msgDiv.style.color = "#22d3ee";
                     msgDiv.style.fontSize = "0.9rem";
                     msgDiv.style.marginBottom = "0.5rem";
                     msgDiv.style.fontWeight = "600";
                     msgDiv.style.display = "flex";
                     msgDiv.style.alignItems = "center";
                     msgDiv.style.gap = "0.5rem";
                     
                     const tableContainer = document.querySelector(".ng-detail-table");
                     if(tableContainer) tableContainer.insertBefore(msgDiv, document.querySelector("#ngDetailTable"));
                     headerMsg = msgDiv;
                 }
                 
                 // Update Message Content
                 headerMsg.setAttribute("data-msg", message); // Store for pagination persistence
                 
                 if (message) {
                      headerMsg.innerHTML = `
                        <span>${message}</span>
                        <button onclick="resetTableFilter()" class="cyber-btn-xs" title="Reset Filter">
                            <i class="ph-x-bold"></i> Reset
                        </button>
                      `;
                 } else {
                      headerMsg.innerHTML = "";
                 }

                 // Calculate Pagination
                 const totalPages = Math.ceil(data.length / rowsPerPage) || 1;
                 // Ensure currentPage is valid
                 if (currentPage > totalPages) currentPage = totalPages;
                 if (currentPage < 1) currentPage = 1;

                 const startIndex = (currentPage - 1) * rowsPerPage;
                 const endIndex = startIndex + rowsPerPage;
                 const pageData = data.slice(startIndex, endIndex);

                 // Update Pagination Info
                 const pageInfo = document.getElementById("pageInfo");
                 if(pageInfo) pageInfo.innerText = `Page ${currentPage} of ${totalPages} (Total: ${data.length})`;
                 
                 const btnPrev = document.getElementById("btnPrevPage");
                 const btnNext = document.getElementById("btnNextPage");
                 if(btnPrev) btnPrev.disabled = currentPage === 1;
                 if(btnNext) btnNext.disabled = currentPage === totalPages;

                 // Render Rows
                 if (tableBody) {
                    tableBody.innerHTML = "";
                    if (data.length === 0) {
                         tableBody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:1rem; color:#94a3b8;'>Data tidak ditemukan.</td></tr>";
                    } else {
                        pageData.forEach(row => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${row.date}</td>
                                <td>${row.machine}</td>
                                <td>${row.checklist}</td>
                                <td>${row.standard}</td>
                                <td>${row.problem}</td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    }
                }
            }
            
            // Global Reset Function
            window.resetTableFilter = function() {
                currentPage = 1;
                renderTable(currentTableData, "");
            };

            
            // Function to update data dynamically
            function updateTrendData(month, year) {
                fetch(`/Home/GetTrendData?month=${month}&year=${year}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            // Update Chart Data
                            const newLabels = data.chartData.map(d => d.label);
                            const newCounts = data.chartData.map(d => d.ngCount);
                            // Update Raw Dates mapping for click event
                            ngRawDates.length = 0; // Clear array
                            data.chartData.forEach(d => ngRawDates.push(d.date));

                            window.myNgChart.data.labels = newLabels;
                            window.myNgChart.data.datasets[0].data = newCounts;
                            window.myNgChart.update();
                            
                            // Update Cached Table Data (data.tableData now includes rawDate from API)
                            currentTableData = data.tableData;

                            // Reset Pagination & View
                            currentPage = 1;
                            renderTable(currentTableData, "");
                        } else {
                            console.error(data.message);
                        }
                    })
                    .catch(e => console.error("Error fetching trend data:", e));
            }
        }
    }
</script>
